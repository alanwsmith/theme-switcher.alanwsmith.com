const t=[5,0,0],e=`bitty-${t[0]}-${t[1]}`,n=new CSSStyleSheet;function s(){return self.crypto.randomUUID()}n.replaceSync(`${e} { display: block; }`),document.adoptedStyleSheets.push(n);class i extends Error{constructor(t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,i),this.name="BittyError";for(let[e,n]of Object.entries(t))this[e]=n}}class r extends HTMLElement{constructor(){super(),this.config={listeners:["click","input"],copyright:"Copyright 2025 - Alan W. Smith",license:"License at: htttp://bitty.alanwsmith.com/ - 2y1pBoEREr3eWA1ubCCOXdmRCdn",version:t},this.receivers=[]}async connectedCallback(){this.dataset.bittyid=s(),await this.makeConnection(),this.conn&&(this.setIds(),this.conn.api=this,this.handleCatchBridge=this.handleCatch.bind(this),this.handleEventBridge=this.handleEvent.bind(this),this.watchMutations=this.handleMutations.bind(this),this.loadReceivers(),this.addObserver(),this.addEventListeners(),await this.callBittyInit(),this.runSendFromComponent())}addEventListeners(){this.dataset.listeners&&(this.config.listeners=this.dataset.listeners.split(/\s+/m).map(t=>t.trim())),this.config.listeners.forEach(t=>{window.addEventListener(t,t=>{t.bittyid=s(),t.target&&t.target.nodeName&&t.target.nodeName.toLowerCase()!==e&&t.target.dataset&&t.target.dataset.send?this.handleEventBridge.call(this,t):this.handleCatchBridge.call(this,t)})})}addObserver(){this.observerConfig={childList:!0,subtree:!0},this.observer=new MutationObserver(this.watchMutations),this.observer.observe(this,this.observerConfig)}addReceiver(t,e){this.conn[t]&&this.receivers.push({key:t,f:n=>{this.conn[t](n,e)}})}async callBittyInit(){"function"==typeof this.conn.bittyInit&&("AsyncFunction"===this.conn.bittyInit[Symbol.toStringTag]?await this.conn.bittyInit():this.conn.bittyInit())}connectedMoveCallback(){}forward(t,e){t||(t={type:"bittyforward"}),t.bittyid||(t.bittyid=s()),t.bitty={forward:e},this.handleEvent(t)}async getElement(t,e=[],n={}){let s=await this.getTXT(t,e,n,"getElement");if(s.error)return s;{const t=document.createElement("template");t.innerHTML=s.value;return{value:t.content.cloneNode(!0).firstChild}}}async getHTML(t,e=[],n={}){const s=await this.getTXT(t,e,n,"getHTML");if(s.error)return s;{const t=document.createElement("template");t.innerHTML=s.value;return{value:t.content.cloneNode(!0)}}}async getJSON(t,e=[],n={}){const s=await this.getTXT(t,e,n,"getJSON");if(s.error)return s;try{const t=JSON.parse(s.value);return{value:t}}catch(t){return{error:new i({type:"parsing"})}}}async getSVG(t,e=[],n={}){const s=await this.getTXT(t,e,n,"getSVG");if(s.error)return s;{const t=document.createElement("template");t.innerHTML=s.value;return{value:t.content.cloneNode(!0).querySelector("svg")}}}async getTXT(t,e=[],n={},s="getTXT"){let r=await fetch(t,n);try{if(r.ok){let t=await r.text();e.forEach(e=>{t=t.replaceAll(e[0],e[1])});return{value:t}}throw new i({type:"fetching",message:`${s}() returned ${r.status} [${r.statusText}] in:\n${s}(${r.url}, ${JSON.stringify(e)}, ${JSON.stringify(n)})`,statusText:r.statusText,status:r.status,url:r.url,incomingMethod:s,subs:e,options:n})}catch(t){return console.error(`BittyError: ${t.message}`),{error:t}}}handleCatch(t){"function"==typeof this.conn.bittyCatch&&this.conn.bittyCatch(t)}handleEvent(t){let e=null;t.bitty&&t.bitty.forward?(e=t.bitty.forward,delete t.bitty.forward):e=t.target.dataset.send,this.processSignals(t,e)}handleMutations(t,e){for(const e of t)"childList"===e.type&&(e.addedNodes.length>0||e.removedNodes.length>0)&&(this.setIds(),this.loadReceivers())}async loadCSS(t,e,n){const s=await this.getTXT(t,e,n,"loadCSS");if(s.error)return s;{const t=new CSSStyleSheet;t.replaceSync(s.value),document.adoptedStyleSheets.push(t);return{value:s.value}}}loadReceivers(){this.receivers=[],this.querySelectorAll("[data-receive]").forEach(t=>{t.dataset.receive.split(/\s+/m).map(t=>t.trim()).forEach(e=>{this.addReceiver(e,t)})})}async makeConnection(){try{if(this.dataset.connect){const t=this.dataset.connect.split(/\s+/m).map(t=>t.trim());if(void 0!==window[t[0]])this.conn=new window[t[0]];else{const e=await import(t[0]);void 0===t[1]?this.conn=new e.default:this.conn=new e[t[1]]}}else window.BittyClass?this.conn=new window.BittyClass:console.error(`${e} error: No class to connect to.`)}catch(t){console.error(`${e} error: ${t} - ${this.dataset.connect}`)}}makeElement(t,e=[]){e.forEach(e=>{t=t.replaceAll(e[0],e[1])});const n=document.createElement("template");n.innerHTML=t.trim();return n.content.cloneNode(!0).firstChild}makeHTML(t,e=[]){e.forEach(e=>{t=t.replaceAll(e[0],e[1])});const n=document.createElement("template");return n.innerHTML=t,n.content.cloneNode(!0)}match(t,e,n=null){return null===n&&(n="bittyid"),void 0!==t.target.dataset[n]&&void 0!==e.dataset[n]&&t.target.dataset[n]===e.dataset[n]}processSignals(t,e){e.split(/\s+/m).map(t=>t.trim()).forEach(e=>{let n=0;this.receivers.forEach(s=>{s.key===e&&(n+=1,s.f(t))}),0===n&&this.conn[e]&&this.conn[e](t,null)})}runSendFromComponent(){this.dataset.send&&this.handleEvent({type:"bittytagdatasend",bittyid:s(),target:this})}setIds(){this.querySelectorAll("*").forEach(t=>{t.dataset.bittyid||(t.dataset.bittyid=s())})}}customElements.define(e,r);