const t=[5,1,0],e=`bitty-${t[0]}-${t[1]}`,n=new CSSStyleSheet;function s(){return self.crypto.randomUUID()}n.replaceSync(`${e} { display: block; }`),document.adoptedStyleSheets.push(n);class a extends Error{constructor(t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,a),this.name="BittyError";for(let[e,n]of Object.entries(t))this[e]=n}}class i extends HTMLElement{constructor(){super(),this.config={listeners:["click","input"],license:"MIT",version:t},this.receivers=[]}async connectedCallback(){this.dataset.bittyid=s(),await this.makeConnection(),this.conn&&(this.setIds(),this.conn.api=this,this.handleCatchBridge=this.handleCatch.bind(this),this.handleEventBridge=this.handleEvent.bind(this),this.watchMutations=this.handleMutations.bind(this),this.loadReceivers(),this.addObserver(),this.addEventListeners(),await this.callBittyInit(),this.runSendFromComponent(),await this.callBittyReady())}addEventListeners(){this.dataset.listeners&&(this.config.listeners=this.dataset.listeners.split(/\s+/m).map(t=>t.trim())),this.config.listeners.forEach(t=>{window.addEventListener(t,t=>{t.bittyid=s(),t.target&&t.target.nodeName&&t.target.nodeName.toLowerCase()!==e&&t.target.dataset&&(t.target.dataset.send||t.target.dataset.s)?this.handleEventBridge.call(this,t):this.handleCatchBridge.call(this,t)})})}addObserver(){this.observerConfig={childList:!0,subtree:!0},this.observer=new MutationObserver(this.watchMutations),this.observer.observe(this,this.observerConfig)}addReceiver(t,e){this.conn[t]&&this.receivers.push({key:t,f:async n=>{await this.conn[t](n,e)}})}async callBittyInit(){"function"==typeof this.conn.bittyInit&&("AsyncFunction"===this.conn.bittyInit[Symbol.toStringTag]?await this.conn.bittyInit():this.conn.bittyInit())}async callBittyReady(){"function"==typeof this.conn.bittyReady&&("AsyncFunction"===this.conn.bittyReady[Symbol.toStringTag]?await this.conn.bittyReady():this.conn.bittyReady())}connectedMoveCallback(){}forward(t,e){t.bitty={forward:e},this.handleEvent(t)}trigger(t){this.handleEvent({type:"bittytrigger",bittyid:s(),bitty:{forward:t}})}async getElement(t,e=[],n={}){let s=await this.getTXT(t,e,n,"getElement");if(s.error)return s;{const t=document.createElement("template");t.innerHTML=s.value;return{value:t.content.cloneNode(!0).firstChild}}}async getHTML(t,e=[],n={}){const s=await this.getTXT(t,e,n,"getHTML");if(s.error)return s;{const t=document.createElement("template");t.innerHTML=s.value;return{value:t.content.cloneNode(!0)}}}async getJSON(t,e=[],n={}){const s=await this.getTXT(t,e,n,"getJSON");if(s.error)return s;try{const t=JSON.parse(s.value);return{value:t}}catch(t){return{error:new a({type:"parsing"})}}}async getSVG(t,e=[],n={}){const s=await this.getTXT(t,e,n,"getSVG");if(s.error)return s;{const t=document.createElement("template");t.innerHTML=s.value;return{value:t.content.cloneNode(!0).querySelector("svg")}}}async getTXT(t,e=[],n={},s="getTXT"){let i=await fetch(t,n);try{if(i.ok){let t=await i.text();e.forEach(e=>{t=t.replaceAll(e[0],e[1])});return{value:t}}throw new a({type:"fetching",message:`${s}() returned ${i.status} [${i.statusText}] in:\n${s}(${i.url}, ${JSON.stringify(e)}, ${JSON.stringify(n)})`,statusText:i.statusText,status:i.status,url:i.url,incomingMethod:s,subs:e,options:n})}catch(t){return console.error(`BittyError: ${t.message}`),{error:t}}}async handleCatch(t){"function"==typeof this.conn.bittyCatch&&await this.conn.bittyCatch(t)}async handleEvent(t){let e="";t.bitty&&t.bitty.forward?(e=t.bitty.forward,delete t.bitty.forward):(t.target.dataset.send&&(e+=`${t.target.dataset.send} `),t.target.dataset.s&&(e+=`${t.target.dataset.s} `)),await this.processSignals(t,e)}handleMutations(t,e){for(const e of t)"childList"===e.type&&(e.addedNodes.length>0||e.removedNodes.length>0)&&(this.setIds(),this.loadReceivers())}async loadCSS(t,e,n){const s=await this.getTXT(t,e,n,"loadCSS");if(s.error)return s;{const t=new CSSStyleSheet;t.replaceSync(s.value),document.adoptedStyleSheets.push(t);return{value:s.value}}}loadReceivers(){this.receivers=[],this.querySelectorAll("[data-receive]").forEach(t=>{t.dataset.receive.split(/\s+/m).map(t=>t.trim()).forEach(e=>{this.addReceiver(e,t)})}),this.querySelectorAll("[data-r]").forEach(t=>{t.dataset.r.split(/\s+/m).map(t=>t.trim()).forEach(e=>{this.addReceiver(e,t)})})}async makeConnection(){try{if(this.dataset.connect){const t=this.dataset.connect.split(/\s+/m).map(t=>t.trim());if(void 0!==window[t[0]])this.conn=new window[t[0]];else{const e=await import(t[0]);void 0===t[1]?this.conn=new e.default:this.conn=new e[t[1]]}}else window.BittyClass?this.conn=new window.BittyClass:console.error(`${e} error: No class to connect to.`)}catch(t){console.error(`${e} error: ${t} - ${this.dataset.connect}`)}}makeElement(t,e=[]){return this.makeHTML(t,e).firstChild}makeHTML(t,e=[]){const n=document.createElement("template");return n.innerHTML=this.makeTXT(t,e).trim(),n.content.cloneNode(!0)}makeTXT(t,e=[]){return e.forEach(e=>{t=t.replaceAll(e[0],e[1])}),t}match(t,e,n="bittyid"){return void 0!==t.target.dataset[n]&&void 0!==e.dataset[n]&&t.target.dataset[n]===e.dataset[n]}async processSignals(t,e){const n=e.split(/\s+/m).map(t=>t.trim());for(let e of n){const n=e.split(":"),s=1===n.length?n[0]:n[1],a="await"===(n.length>=2?n[0]:"");let i=0;for(const e of this.receivers)e.key===s&&(i+=1,!0===a?await e.f(t):e.f(t));0===i&&this.conn[s]&&(!0===a?await this.conn[s](t,null):this.conn[s](t,null))}}runSendFromComponent(){this.dataset.send&&this.handleEvent({type:"bittytagdatasend",bittyid:s(),target:this}),this.dataset.s&&this.handleEvent({type:"bittytagdatasend",bittyid:s(),target:this})}setProp(t,e){document.documentElement.style.setProperty(t,e)}setIds(){this.querySelectorAll("*").forEach(t=>{t.dataset.bittyid||(t.dataset.bittyid=s())})}}customElements.define(e,i);